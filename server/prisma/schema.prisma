// Remove the preview feature since it's deprecated
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String            @id @default(uuid())
  name            String
  email           String            @unique
  image           String            @default("")
  role            UserRole          @default(MEMBER) // üÜï ADDED: Global user role
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // üîê Authentication fields
  passwordHash    String?
  emailVerified   Boolean           @default(false)
  verificationToken String?
  resetToken      String?
  resetTokenExpiry DateTime?
  
  // Existing relations
  comments        Comment[]
  commentLinks    CommentLink[]
  projects        Project[]         @relation("ProjectOwner")
  ProjectMember   ProjectMember[]
  assignedTasks   TaskAssignee[]
  taskLinks       TaskLink[]
  ownedWorkspaces Workspace[]
  workspaces      WorkspaceMember[]
}

// üÜï ADDED: Global user roles for workspace creation permissions
enum UserRole {
  SUPER_ADMIN  // Can create workspaces for other users
  ADMIN        // Can create unlimited workspaces  
  MEMBER       // Limited to 3 workspaces (default)
}

model Workspace {
  id          String            @id @default(uuid())
  name        String
  slug        String            @unique
  description String?
  settings    Json              @default("{}")
  ownerId     String
  createdAt   DateTime          @default(now())
  image_url   String            @default("")
  updatedAt   DateTime          @updatedAt
  projects    Project[]
  owner       User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members     WorkspaceMember[]
}

model WorkspaceMember {
  id          String        @id @default(uuid())
  userId      String
  workspaceId String
  message     String        @default("")
  role        WorkspaceRole @default(MEMBER)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

model Invitation {
  id          String            @id @default(uuid())
  email       String
  workspaceId String
  role        WorkspaceRole     @default(MEMBER)
  invitedById String
  status      InvitationStatus  @default(PENDING)
  message     String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation(fields: [invitedById], references: [id], onDelete: Cascade)

  @@unique([email, workspaceId])
  @@index([email])
  @@index([status])
}


model Project {
  id          String          @id @default(uuid())
  name        String
  description String?
  priority    Priority        @default(MEDIUM)
  status      ProjectStatus   @default(ACTIVE)
  start_date  DateTime?
  end_date    DateTime?
  team_lead   String
  workspaceId String
  progress    Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  owner       User            @relation("ProjectOwner", fields: [team_lead], references: [id], onDelete: Cascade)
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members     ProjectMember[]
  tasks       Task[]
  folders     Folder[]
}

model Folder {
  id          String   @id @default(uuid())
  name        String
  description String?
  projectId   String
  position    Int?     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]
  
  @@unique([projectId, name])
  @@index([projectId])
}

model ProjectMember {
  id        String  @id @default(uuid())
  userId    String
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

model Task {
  id          String         @id @default(uuid())
  projectId   String
  folderId    String?
  title       String
  description String?
  status      TaskStatus     @default(TODO)
  type        TaskType       @default(GENERAL_TASK)
  priority    Priority       @default(MEDIUM)
  due_date    DateTime?
  position    Int?           @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  comments    Comment[]
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  folder      Folder?        @relation(fields: [folderId], references: [id], onDelete: SetNull)
  assignees   TaskAssignee[]
  links       TaskLink[]
  
  @@index([projectId])
  @@index([folderId])
}

model TaskAssignee {
  id         String   @id @default(uuid())
  taskId     String
  userId     String
  assignedAt DateTime @default(now())
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
}

model Comment {
  id        String        @id @default(uuid())
  content   String
  userId    String
  taskId    String
  createdAt DateTime      @default(now())
  task      Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  links     CommentLink[]
}

model TaskLink {
  id        String   @id @default(uuid())
  url       String
  title     String?
  taskId    String
  userId    String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

model CommentLink {
  id        String   @id @default(uuid())
  url       String
  commentId String
  userId    String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([commentId])
  @@index([userId])
}

// Workspace-level roles (for permissions within a workspace)
enum WorkspaceRole {
  ADMIN
  MEMBER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  INTERNAL_REVIEW
  DONE
  CANCELLED
}

enum TaskType {
  GENERAL_TASK
  WEEKLY_EMAILS
  CALENDARS
  CLIENT
  SOCIAL
  OTHER
}

enum ProjectStatus {
  ACTIVE
  PLANNING
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}